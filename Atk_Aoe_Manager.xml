<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, December 21, 2024, 12:21 AM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "Atk_Aoe_Manager" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Atk_Aoe_Manager"
   author="Khrysis"
   id="689c1286fe55ac130d90458c"
   language="Lua"
   purpose="Manage Your Atk and Aoe spells"
   save_state="y"
   date_written="2024-12-21 00:10:03"
   requires="5.07"
   version="1.2"
   >
<description trim="y">
<![CDATA[
This plugin allows you to dynamically add and remove attack and AoE spells using the 'aam add' and 'aam rem' aliases. 
The triggers will now check these tables for spell matches, with regex dynamically updated.
You can also list the current attack and AoE spells with 'aam list patk', 'aam list aoe', or 'aam list all'.
]]>
</description>

</plugin>

<!--  Triggers  -->

<triggers>
<!-- Combined Trigger for Expert-level AoE and Attack spells -->
<trigger
   enabled="y"
   group="set spell on tier or R1"
   match="^You are now an expert in (.*)\.$"
   regexp="y"
   expand_variables="y"
   send_to="12"
   sequence="100"
  >
    <send>
      -- Get the spell name
      local spell = "%1"
      local found = false
      local spellCategory = nil  -- Track the spell category (Patk or Aoe)

      -- Check Patk first
      for _, v in ipairs(Patk) do
        if string.lower(v) == string.lower(spell) then
          spellCategory = "atk"
          found = true
          break
        end
      end

      -- If not found in Patk, check Aoe
      if not found then
        for _, v in ipairs(Aoe) do
          if string.lower(v) == string.lower(spell) then
            spellCategory = "aoe"
            found = true
            break
          end
        end
      end

      -- If the spell is found, update the appropriate variable
      if found then
        if spellCategory == "atk" then
          local currentSpell = GetVariable("atkspell")
          if string.lower(currentSpell) ~= string.lower(spell) then
            SetVariable("atkspell", spell)
            Note("Attack spell is now: " .. spell)
          end
        elseif spellCategory == "aoe" then
          local currentSpell = GetVariable("aoespell")
          if string.lower(currentSpell) ~= string.lower(spell) then
            SetVariable("aoespell", spell)
            Note("AoE spell is now: " .. spell)
          end
        end
	 end
    </send>
  </trigger>

<!-- Combined Trigger for 95% match AoE and Attack spells -->
<trigger
   enabled="y"
   group="set spell (95%)"
   match="^Spell (.*)\. \(95\%\)$"
   regexp="y"
   expand_variables="y"
   send_to="12"
   sequence="100"
  >
    <send>
      -- Get the spell name
      local spell = "%1"
      local found = false
      local spellCategory = nil  -- Track the spell category (Patk or Aoe)

      -- Check Patk first
      for _, v in ipairs(Patk) do
        if string.lower(v) == string.lower(spell) then
          spellCategory = "atk"
          found = true
          break
        end
      end

      -- If not found in Patk, check Aoe
      if not found then
        for _, v in ipairs(Aoe) do
          if string.lower(v) == string.lower(spell) then
            spellCategory = "aoe"
            found = true
            break
          end
        end
      end

      -- If the spell is found, update the appropriate variable
      if found then
        if spellCategory == "atk" then
          local currentSpell = GetVariable("atkspell")
          if string.lower(currentSpell) ~= string.lower(spell) then
            SetVariable("atkspell", spell)
            Note("Attack spell is now: " .. spell)
          end
        elseif spellCategory == "aoe" then
          local currentSpell = GetVariable("aoespell")
          if string.lower(currentSpell) ~= string.lower(spell) then
            SetVariable("aoespell", spell)
            Note("AoE spell is now: " .. spell)
          end
        end
	 end
    </send>
  </trigger>



</triggers>

<!-- Aliases -->
<aliases>
  <!-- Add primary attack spell -->
  <alias
   match="aam add patk (.*)"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>local spell = "%1"
      -- Add spell to the Patk table (case-insensitive check for existing spell)
      local found = false
      for _, v in ipairs(Patk) do
        if string.lower(v) == string.lower(spell) then
          found = true
          break
        end
      end
      if not found then
        table.insert(Patk, spell)
        Note("Added primary attack spell: " .. spell)
      else
        Note("Spell already exists in the primary attack spells list.")
      end
    </send>
  </alias>

  <!-- Remove primary attack spell -->
  <alias
   match="aam rem patk (.*)"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>
      local spell = "%1"
      -- Find the index of the spell in the Patk table (case-insensitive)
      local index = nil
      for i, v in ipairs(Patk) do
        if string.lower(v) == string.lower(spell) then
          index = i
          break
        end
      end
      -- Remove spell if found
      if index then
        table.remove(Patk, index)
        Note("Removed primary attack spell: " .. spell)
      else
        Note("Spell not found in the primary attack spells.")
      end
    </send>
  </alias>

  <!-- Add AoE spell -->
  <alias
   match="aam add aoe (.*)"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>local spell = "%1"
      -- Add spell to the Aoe table (case-insensitive check for existing spell)
      local found = false
      for _, v in ipairs(Aoe) do
        if string.lower(v) == string.lower(spell) then
          found = true
          break
        end
      end
      if not found then
        table.insert(Aoe, spell)
        Note("Added AoE spell: " .. spell)
      else
        Note("Spell already exists in the AoE spells list.")
      end
    </send>
  </alias>

  <!-- Remove AoE spell -->
  <alias
   match="aam rem aoe (.*)"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>
      local spell = "%1"
      -- Find the index of the spell in the Aoe table (case-insensitive)
      local index = nil
      for i, v in ipairs(Aoe) do
        if string.lower(v) == string.lower(spell) then
          index = i
          break
        end
      end
      -- Remove spell if found
      if index then
        table.remove(Aoe, index)
        Note("Removed AoE spell: " .. spell)
      else
        Note("Spell not found in the AoE spells.")
      end
    </send>
  </alias>

  <!-- List Primary Attack Spells, AoE Spells, or Both -->
  <alias
   match="aam list (all|patk|aoe)"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>
      local listType = "%1"
      
      if listType == "patk" then
        if #Patk == 0 then
          Note("No primary attack spells available.")
        else
          Note("Primary Attack Spells: " .. table.concat(Patk, ", "))
        end
      elseif listType == "aoe" then
        if #Aoe == 0 then
          Note("No AoE spells available.")
        else
          Note("AoE Spells: " .. table.concat(Aoe, ", "))
        end
      else
        -- For "all", show both Patk and Aoe
        if #Patk == 0 and #Aoe == 0 then
          Note("No spells available.")
        else
          if #Patk > 0 then
            Note("Primary Attack Spells: " .. table.concat(Patk, ", "))
          else
            Note("No primary attack spells available.")
          end
          if #Aoe > 0 then
            Note("AoE Spells: " .. table.concat(Aoe, ", "))
          else
            Note("No AoE spells available.")
          end
        end
      end
    </send>
  </alias>

  <!-- Show Help -->
  <alias
   script="OnHelp"
   match="aam help"
   enabled="y"
  >
  </alias>

  <!-- Cast Attack Spell -->
  <alias
   match="aam atk"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
  >
    <send>-- get variable
	atkspell = GetVariable("atkspell")
      -- Cast the attack spell
      if atkspell then
        Send("c '".. atkspell .."'")
        Note("Casting attack spell: " .. atkspell)
      else
        Note("No primary attack spell selected.")
      end
    </send>
  </alias>

  <!-- Cast AoE Spell -->
  <alias
   match="aam aoe"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
  >
    <send>-- get variable
	aoespell = GetVariable("aoespell")
      -- Cast the AoE spell
      if aoespell then
        Send("c '".. aoespell .."'")
        Note("Casting AoE spell: " .. aoespell)
      else
        Note("No AoE spell selected.")
      end
    </send>
  </alias>

  <!-- Set the atkspell -->
  <alias
   match="aam set atk (.*)"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
  >
    <send>atkspell = "%1"
      SetVariable("atkspell", "%1")
      Note("Set the attack spell to: " .. atkspell)
    </send>
  </alias>

  <!-- Set the aoespell -->
  <alias
   match="aam set aoe (.*)"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   regexp="y"
  >
    <send>aoespell = "%1"
      SetVariable("aoespell", "%1")
      Note("Set the AoE spell to: " .. aoespell)
    </send>
  </alias>

  <!-- Clear primary attack or AoE or both spells -->
  <alias
   match="aam clear (patk|aoe|all)"
   enabled="y"
   group="attack"
   send_to="12"
   sequence="100"
   expand_variables="y"
   regexp="y"
  >
    <send>
      local target = "%1"
      if target == "patk" then
        -- Clear all primary attack spells
        Patk = {}
        SetVariable("Patk", "Patk = {}")
        Note("Cleared all primary attack spells.")
      elseif target == "aoe" then
        -- Clear all AoE spells
        Aoe = {}
        SetVariable("Aoe", "Aoe = {}")
        Note("Cleared all AoE spells.")
      else
        -- Clear both primary attack and AoE spells
        Patk = {}
        Aoe = {}
        SetVariable("Patk", "Patk = {}")
        SetVariable("Aoe", "Aoe = {}")
        Note("Cleared all primary attack and AoE spells.")
      end
    </send>
  </alias>

</aliases>

<!-- Script -->
<script>
<![CDATA[

require "serialize"

-- Initialize the tables for storing attack and AoE spells
Patk = {}
Aoe = {}

-- Function to check if a value exists in a table (case-insensitive)
function table.contains(tbl, val)
  for _, v in ipairs(tbl) do
    if string.lower(v) == string.lower(val) then
      return true
    end
  end
  return false
end

-- Help function to explain how the plugin works
function OnHelp()
  Note("Plugin help: ")
  Note("")
  Note("aam add patk/aoe [spell] - Add a primary attack or aoe spell to the list.")
  Note("aam rem patk/aoe [spell] - Remove a primary attack or aoe spell from the list.")
  Note("aam list patk/aoe/all - List spells from patk, aoe, or both.")
  Note("aam clear patk/aoe/all - Clear list from patk, aoe, or both.")
  Note("aam set atk/aoe [spell] - Set the atk or aoe spell.")
  Note("aam atk - Casts the spell set for atk.")
  Note("aam aoe - Casts the spell set for aoe.")
  Note("")
end

-- Save the stored tables and reload them on new session
function OnPluginSaveState ()
  -- Save both spellsTable and currentIndex
  SetVariable("Patk", "Patk = " .. serialize.save_simple(Patk))
  SetVariable("Aoe", "Aoe = " .. serialize.save_simple(Aoe))
end

function OnPluginInstall ()
  ColourNote("blue", "yellow", "Plugin Installed! Type aam help - to show help")
  assert(loadstring(GetVariable("Patk") or ""))()
  assert(loadstring(GetVariable("Aoe") or ""))()
end
]]>
</script>

</muclient>
