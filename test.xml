<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="test"
   author="Khrysis"
   id="7f7f828229d927ee64688f12"
   language="Lua"
   purpose="testing update"
   save_state="y"
   date_written="2022-04-18 11:26:19"
   requires="5.07"
   version="1.0"
   >
<description trim="y">
<![CDATA[
testing update function
]]>
</description>

</plugin>


<!--  Aliases  -->

<aliases>
  <alias
   script="update_plugin"
   match="^cprac update$"
   enabled="y"
   regexp="y"
   sequence="100"
  >
  </alias>
</aliases>

<!--  Plugin help  -->

<aliases>
  <alias
   script="OnHelp"
   match="test:help"
   enabled="y"
  >
  </alias>
</aliases>

<script>
<![CDATA[

local https = require "ssl.https"
Remote = {}
function update_plugin(alias, line, wc)
    local url = "https://github.com/Khrysis-aard/plugins/main/test.xml"
    local xml = https.request(url)
    if (not xml) then
        Utility.msg_prim("Failed to download remote plugin file.")
        return false
    end
    local pluginID = GetPluginID()
    local localVersion = GetPluginInfo(pluginID, 19) or 0
    local localVersionStr = string.format("%1.2f", localVersion)
    local remoteVersionStr = xml:match('%s%s+version="([0-9%.]+)"')
    local remoteVersion = tonumber(remoteVersionStr or "") or 0
    if (localVersion == remoteVersion) then
        Utility.msg_prim("Version is up to date.")
        return true
    end
    Utility.msg_prim(string.format(
        "Updating from v%s to v%s...",
        localVersionStr, remoteVersionStr
    ))
    Utility.msg_sec("Please do not touch anything.")
    local fileName = GetPluginInfo(pluginID, 6)
    local file = assert(io.open(fileName, "w"))
    file:write(xml)
    file:close()
    Utility.reload_plugin()
    return true
end

function OnHelp ()
  world.Note (world.GetPluginInfo (world.GetPluginID (), 3))
end
]]>
</script> 

</muclient>
