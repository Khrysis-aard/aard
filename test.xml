<?xml version="1.1" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="test"
   author="Khrysis"
   id="7f7f828229d927ee64688f12"
   language="Lua"
   purpose="testing update"
   save_state="y"
   date_written="2022-04-18 11:26:19"
   requires="5.07"
   version="1.1"
   >
<description trim="y">
<![CDATA[
testing update function
]]>
</description>

</plugin>


<!--  Aliases  -->

<aliases>
  <alias
   script="update_plugin"
   match="^cprac update$"
   enabled="y"
   regexp="y"
   sequence="100"
  >
  </alias>
</aliases>

<!--  Plugin help  -->

<aliases>
  <alias
   script="OnHelp"
   match="test:help"
   enabled="y"
  >
  </alias>
</aliases>

<script>
<![CDATA[

    function update_plugin()
        raw = "https://raw.githubusercontent.com/Khrysis-aard/plugins/main/test.xml"
        async_ok, async = pcall (require, "async")
        if async_ok then
            plugin_page = async.doAsyncRemoteRequest(raw, raw_get, "HTTPS")
        else
            ColourNote("white", "blue", "Error on plugin update!")
        end
    end
    function raw_get(retval, page, status, headers, full_status, request_url)
            raw_version = tonumber(string.match(page, '%s+version="([0-9%.]+)"'))

        if raw_version == PLUGIN_VERSION then
            ColourNote("white", "blue", PLUGIN_NAME .. " is up-to-date.")
        elseif raw_version > PLUGIN_VERSION then
            ColourNote("white", "blue", "Updating from version " .. PLUGIN_VERSION .. " to " .. raw_version .. ". Do not touch anything!")
            local file = io.open(GetPluginInfo(GetPluginID(), 6), "w")
            file:write(page)
            file:close()
            if "" == GetAlphaOption("script_prefix") then
                SetAlphaOption("script_prefix", "\\\\\\")
            end
            Execute(GetAlphaOption("script_prefix") .. "DoAfterSpecial(1, \"ReloadPlugin('" .. GetPluginID() .. "')\", sendto.script)")
            ColourNote("white", "blue", "Update complete!")
        end
        raw_version = nil
    end -- end Update code

    function OnPluginInstall()
        PLUGIN_VERSION  = GetPluginInfo(GetPluginID(), 19)
        PLUGIN_NAME   = GetPluginInfo(GetPluginID(), 1)
    end

    function OnHelp ()
        world.Note (world.GetPluginInfo (world.GetPluginID (), 3))
    end
]]>
</script> 

</muclient>
